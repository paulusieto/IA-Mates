<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QCM Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <button class="menu-button" onclick="toggleMenu()">‚ò∞ Menu</button>
    <h1 class="notranslate">IA Mates</h1>
  </header>

  <nav id="sidebar">
    <button class="close-button" onclick="toggleMenu()">√ó</button>
    <ul>
      <li><a class="notranslate" href="#">EPAC</a></li>
      <li><a class="notranslate" href="#">Pr√©-Exam</a></li>
      <li><a class="notranslate" href="#">Paper D</a></li>
    </ul>
  </nav>
  
  <div class="language-selector">
    <div class="language-icon notranslate" onclick="toggleLanguageMenu()">üåç</div>
    <div class="language-menu" id="languageMenu">
      <button class="translateButton notranslate" data-lang="fr">FR</button>
      <button class="translateButton notranslate" data-lang="en">EN</button>
      <button class="translateButton notranslate" data-lang="de">DE</button>
    </div>
  </div>
  
  <div class="chatbox" id="chat"></div>
  <div class="choices" id="choices"></div>
  <button id="nextQuestion" onclick="displayQuestion()" style="display:none;">Question suivante</button>

  <script id="questionsData" type="application/json">
    {{ questions | tojson | safe }}
  </script>

  <script>
    function toggleMenu() {
      document.getElementById("sidebar").classList.toggle("active");
      document.body.classList.toggle("sidebar-active");
    }

    function toggleLanguageMenu() {
      document.getElementById("languageMenu").classList.toggle("show");
    }

    function changeLanguage(lang) {
      alert("Langue chang√©e en : " + lang);
    }

    window.onclick = function(event) {
      if (!event.target.matches('.language-icon')) {
        var dropdowns = document.getElementsByClassName("language-menu");
        for (var i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }

    const questions = JSON.parse(document.getElementById("questionsData").textContent);
    const chat = document.getElementById("chat");
    const choicesDiv = document.getElementById("choices");
    const nextButton = document.getElementById("nextQuestion");
    let current = null;
    let answered = false;

   function appendMessage(text, sender) {
  const div = document.createElement("div");
  div.className = "message " + sender;
  if (sender === "user") {  // Assure-toi que c'est un message de l'utilisateur
    div.classList.add("notranslate"); // Ajoute la classe notranslate
  }
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}


    function displayQuestion() {
      current = questions[Math.floor(Math.random() * questions.length)];
      fetch("/api/clarify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: current.question })
      })
      .then(res => res.json())
      .then(parsed => {
        appendMessage(parsed.question, "bot");
        showChoices(parsed.choices);
        answered = false;
        nextButton.style.display = "none";
      })
      .catch(() => {
        appendMessage("‚ùå Error loading question", "bot");
      });
    }

    function showChoices(choices) {
      choicesDiv.innerHTML = "";
      choices.forEach(choice => {
        const letter = choice[0];
        const btn = document.createElement("button");
        btn.textContent = choice;
        btn.onclick = () => submitAnswer(letter);
        choicesDiv.appendChild(btn);
      });
    }

    function submitAnswer(letter) {
      if (answered) return;
      answered = true;

      appendMessage(letter, "user");

      fetch("/api/check", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chunk_id: current.chunk_id, user_answer: letter })
      })
      .then(res => res.json())
      .then(data => {
        let msg = "";
        if (data.correct === true) {
        msg = `‚úÖ Good answer !\n\n${data.explanation}`;
        } else if (data.correct === false) {
        msg = `‚ùå Wrong answer. The good answer was ${data.correct_letter}.\n\n${data.explanation}`;
        } else {
        msg = `Response assessed by AI  : ${data.explanation}`;
        }
        appendMessage(msg, "bot");
        nextButton.style.display = "block";
        disableChoices();
      })
      .catch(() => {
        appendMessage("‚ùå Answer verification error", "bot");
        nextButton.style.display = "block";
      });
    }

    function disableChoices() {
      const buttons = choicesDiv.getElementsByTagName("button");
      for (let btn of buttons) {
        btn.disabled = true;
      }
    }

    window.onload = displayQuestion;
  </script>
  <!-- Script Google Translate -->
  <div id="google_translate_element" display="none"></div>

  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
    }
  
    function changeLanguage(lang) {
      let select = document.querySelector(".goog-te-combo");
      if (select) {
        select.value = lang;
        select.dispatchEvent(new Event("change"));
      } else {
        alert("Google Translate is not yet ready. Wait a few seconds and then try again.");
      }
    }
  
    document.querySelectorAll(".translateButton").forEach(button => {
      button.addEventListener("click", function() {
        changeLanguage(this.getAttribute("data-lang"));
      });
    });
  </script>
  <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>
</html>
